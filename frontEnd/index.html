<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KABAN SYSTEM</title>
    <link rel="stylesheet" href="static/css/styles.css">
</head>
<body>
    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <header class="top-panel">
        <h1>KABAN SYSTEM - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3D –ø—Ä–∏–Ω—Ç–µ—Ä–∞–º–∏</h1>
    </header>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <aside class="sidebar">
        <h2>–ú–µ–Ω—é</h2>
    </aside>

    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <main class="main-content">
        <div class="printers-container" id="printers-container">
            <!-- –ü—Ä–∏–Ω—Ç–µ—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </main>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
        async function loadPrinters() {
            try {
                const response = await fetch('/all_printers');
                const printers = await response.json();
                
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤:', printers.length);
                console.log('–î–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤:', printers);
                
                if (printers && printers.length > 0) {
                    displayPrinters(printers);
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –≤ –ë–î, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showEmptyDatabaseMessage();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤:', error);
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ç–æ–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–∏–Ω—Ç–µ—Ä—ã
                const testPrinters = [
                    {
                        "id": "–ù3",
                        "name": "3D –ü—Ä–∏–Ω—Ç–µ—Ä –ù3",
                        "ip": "192.168.1.100",
                        "camera": 1
                    },
                    {
                        "id": "–°–ª–æ–Ω",
                        "name": "3D –ü—Ä–∏–Ω—Ç–µ—Ä –°–ª–æ–Ω", 
                        "ip": "192.168.1.101",
                        "camera": 2
                    }
                ];
                displayPrinters(testPrinters);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤
        function displayPrinters(printers) {
            const container = document.getElementById('printers-container');
            container.innerHTML = '';
            
            console.log('–°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤:', printers);
            
            printers.forEach((printer, index) => {
                console.log(`–°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É ${index + 1} –¥–ª—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞:`, printer);
                const printerCard = createPrinterCard(printer);
                container.appendChild(printerCard);
                console.log(`–ö–∞—Ä—Ç–æ—á–∫–∞ ${index + 1} –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
            });
            
            console.log('–í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–æ–∑–¥–∞–Ω–æ:', container.children.length);
        }

        // –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–æ—Ç–æ
        async function updateAllPhotos(printers) {
            for (const printer of printers) {
                try {
                    await updatePrinterPhoto(printer.id, printer.name, true);
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ –¥–ª—è ${printer.name}:`, error);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
        function createPrinterCard(printer) {
            const card = document.createElement('div');
            card.className = 'printer-info-card';
            
            card.innerHTML = `
                <div class="printer-image">
                    <img src="/printer_photo/${printer.name}" alt="3D –ü—Ä–∏–Ω—Ç–µ—Ä ${printer.name}" class="printer-photo" onerror="this.src='/printer_photo/–ù3'">
                </div>
                <div class="printer-details">
                    <h2 class="printer-name">${printer.name}</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">ID –ø—Ä–∏–Ω—Ç–µ—Ä–∞:</span>
                            <span class="info-value">${printer.id}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">IP –∞–¥—Ä–µ—Å:</span>
                            <span class="info-value">${printer.ip}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–ö–∞–º–µ—Ä–∞:</span>
                            <span class="info-value">${printer.camera}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–°—Ç–∞—Ç—É—Å:</span>
                            <span class="info-value status-online">–û–Ω–ª–∞–π–Ω</span>
                        </div>
                    </div>
                    <button class="update-photo-btn-bottom" onclick="updatePrinterPhoto('${printer.id}', '${printer.name}')">
                        üì∏ –û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ
                    </button>
                </div>
            `;
            
            return card;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø—É—Å—Ç–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        function showEmptyDatabaseMessage() {
            const container = document.getElementById('printers-container');
            container.innerHTML = `
                <div class="empty-database-message">
                    <div class="empty-icon">üìã</div>
                    <h2>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞</h2>
                    <p>–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>
                    <p>–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–Ω—Ç–µ—Ä—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.</p>
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
        function showTestPrinter() {
            const container = document.getElementById('printers-container');
            container.innerHTML = `
                <div class="printer-info-card">
                    <div class="printer-image">
                        <img src="/printer_photo/–ù3" alt="3D –ü—Ä–∏–Ω—Ç–µ—Ä –ù3" class="printer-photo">
                    </div>
                    <div class="printer-details">
                        <h2 class="printer-name">3D –ü—Ä–∏–Ω—Ç–µ—Ä –ù3</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">ID –ø—Ä–∏–Ω—Ç–µ—Ä–∞:</span>
                                <span class="info-value">–ù3</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">IP –∞–¥—Ä–µ—Å:</span>
                                <span class="info-value">192.168.1.100</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">–ö–∞–º–µ—Ä–∞:</span>
                                <span class="info-value">1</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">–°—Ç–∞—Ç—É—Å:</span>
                                <span class="info-value status-online">–û–Ω–ª–∞–π–Ω</span>
                            </div>
                        </div>
                        <button class="update-photo-btn-bottom" onclick="updatePrinterPhoto('–ù3', '–ù3')">
                            üì∏ –û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ
                        </button>
                    </div>
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
        async function updatePrinterPhoto(printerId, printerName, silent = false) {
            try {
                const response = await fetch(`/update_printer_photo/${printerId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    const img = document.querySelector(`img[alt="3D –ü—Ä–∏–Ω—Ç–µ—Ä ${printerName}"]`);
                    if (img) {
                        img.src = `/printer_photo/${printerName}?t=${Date.now()}`;
                    }
                    
                    if (!silent) {
                        alert('–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
                    }
                } else {
                    const error = await response.json();
                    if (!silent) {
                        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ: ' + error.detail);
                    }
                }
            } catch (error) {
                if (!silent) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
                }
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–Ω—Ç–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤...');
            loadPrinters();
        });
    </script>
</body>
</html> 